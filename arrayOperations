#include <iostream>
#include <cstdio>
#include <fstream>
#include <cmath>
#include <vector>

using namespace std; 

void imprimir_matriz(float X[], int m, int n );

float* mulMat(float X[],float Y[], int xr, int xy, int yc );

float* transMat(float X[], int m, int n );

float determinantTwo(float X[], int n);

float* adjMat(float X[], int n);

float* divEscMat(float X[], float divisor, int n, int m);

int main(){
    int k = 3; // meses del ano (meses por periodo 3, es un trimestre)
    int m = 8; // numero total de anos (de trimestres, en este caso 8, se tiene los datos para 2 anos)
    int n = m * k;
    
    float* Z =new float [n]; // se declara la serie de datos del ISE
    float* Y =new float [m]; // se declara la serie de datos del PIB disponible
    float* X =new float [n]; // se declara la serie de datos del PIB mensualizado

    float datosISE[] = {
        60.1,
        61.6,
        62.2,
        63.1,
        62.7,
        63.6,
        63.9,
        65.2,
        65.8,
        66.0,
        68.6,
        73.7,
        62.6,
        64.7,
        66.8,
        64.4,
        66.9,
        66.7,
        68.5,
        69.8,
        71.2,
        71.1,
        74.5,
        77.4 };
    float datosPIB[] = {
        121.278,
        125.664,
        129.103,
        138.808,
        128.999,
        132.349,
        138.998,
        149.088 };

    
	  float* A =new float [n*n]; // Matriz A inversa del problema de minimizacion
    float* B =new float[n*m]; //Matriz de ceros y unos
///////////////////////// Llenando de elementos los arreglos anteriores:

    // se llena el vector Z:
    for(int i=0; i<n; i++)
    {
      Z[i] = datosISE[i];
    }

    // se llena el vector Y:
    for(int i=0; i<m; i++)
    {
      Y[i] = datosPIB[i];
    }

    // se llena la matriz A:
    for(int i=0; i<n; i++){
      for(int j=0; j<n; j++){
        if(i <= j ){
          A[(i*n) + j] = i + 1; 
        } else {
          A[(i*n) + j] = j + 1;
        }
      }
    }


     // se llena la matriz B:
    int count = 0; 
    int change = 0; 
    for(int i=0; i<n; i++){
      if(count < k){
      ++ count;
        for(int j=0; j<m; j++){
          if(j == change){
            B[i*m + j] =  1;
          } else {
            B[i*m + j] =  0;
          }
        }
      } else {
        change += 1;
        count = 0; 
        i = i - 1; 
      }
    }


    float* AB = mulMat(A,B, n, n, m); //Matriz resultado de la multiplicacion de A inversa y B
    float* transB = transMat(B, n, m ); //Matriz transpuesta de B
    float* BtAB = mulMat(transB, AB, m, n, m); //Matriz resultado de la multiplicacion de B transpuesta y A inversa B
    float* adjBtAB = adjMat(BtAB, m); //Matriz adjunta de BtAB
    float* transAdjBtAB = transMat(adjBtAB, m, m); //Matriz transpuesta de adjBtAB
    
    float determinanteBtAB = determinantTwo(BtAB, m); //determinante de la matriz BtAB
    
    float* invBtAB = divEscMat(transAdjBtAB, determinanteBtAB, m, m); //Matriz inversa de la matriz BtAB
    float* C = mulMat(AB, invBtAB, n, m, m); //Matriz resultado de la multiplicacion de A inversa B y invBtAB

    float* BtZ = mulMat(transB, Z, m, n, 1);

    // se llena la matriz D:
    // int sumaD = 0;
    // for(int i=0; i<nD; i++){
    //   for(int j=0; j<nD; j++){
    //       D[(i*nD) + j] = datosPrueba[sumaD];
    //       sumaD++; 
    //   }
    // }


  // printf("Esta es la matriz D: \n");
  // imprimir_matriz(D, nD, nD);
  // printf("\n");
  // float determinante = determinantTwo(D,nD);
  // printf("El determinante de D es:");
  // printf("%5.2f  ", determinante);
  // printf("\n");

//   printf("Aca calculamos la adjunta de D:");
//   float* AdjD = adjMat(D, nD);  

//   printf("Esta es su matriz adjunta ADJ: XD \n");
//   for(int i=0;i<n;i++){
//     for(int j=0;j<n;j++){
//       printf("%12.2f  ", AdjD[(i*n) + j]);
//     }
//     printf("\n");
//   }

//   printf("Esta es la transpuesta de ADJ: \n");
//   float* transAdjD= transMat(AdjD, n, n );
//   for(int i=0;i<n;i++){
//     for(int j=0;j<n;j++){
//       printf("%12.2f  ", transAdjD[(i*n) + j]);
//     }
//     printf("\n");
//   }


//   printf("Esta es la inversa de D: \n");
//   float* invMat = divEscMat(transAdjD, determinante, n, n);
//   for(int i=0;i<n;i++){
//     for(int j=0;j<n;j++){
//       printf("%12.2f  ", invMat[(i*n) + j]);
//     }
//     printf("\n");
//   }

//   printf("Aca corroboramos que la inversa si es al multiplical D por invD: \n");
//   float* unitMat = mulMat(D,invMat,nD, nD, nD);
//  for(int i=0;i<nD;i++){
//     for(int j=0;j<nD;j++){
//       printf("%12.2f  ", unitMat[(i*nD) + j]);
//     }
//     printf("\n");
//   }
//   printf("---------------------------------------");



  // printf("Esta es la matriz A: \n");
  // imprimir_matriz(A, n, n);
  // printf("\n");
  // // float determinante = determinantTwo(A,n);
  // printf("El determinante de A es:");
  // printf("%5.2f  ", determinante);
  // printf("\n");
/////// Imprimiendo los arreglos que se van a usar:

    // imprimimos Z en pantalla:
    printf("Este es el vector Z del ISE mensual: \n");
    for(int j=0; j<n; j++)
    {
      printf("%5.2f  ", Z[j]);
      printf(" \n");
    }

    // imprimimos Y en pantalla:
    printf("Este es el vector Y del PIB trimestral: \n");
    for(int j=0; j<m; j++)
    {
      printf("%5.2f  ", Y[j]);
      printf(" \n");
    }


    // imprimimos A en pantalla:
    printf("Esta es la matriz A^-1 de la minimizacion: \n");
    imprimir_matriz(A, n, n);

    //imprimimos C en pantalla:
    printf("Esta es la matriz B del Lagrangiano: \n");
    imprimir_matriz(B, n, m);


  // printf("Esta es la transpuesta de B: \n");
  // imprimir_matriz(transB, m, n);


  // printf("Esta es la matriz de datosPruba: \n");
  // imprimir_matriz(datosPrueba, 3, 12);
  // printf("Esta es la transpuesta de datosPruba: \n");
  // float* transDatosPrueba = transMat(datosPrueba, 3, 12 );
  // imprimir_matriz(transDatosPrueba, 12, 3);
  // printf("Esta es la transpuesta de A: \n");
  // transMat(A, n, n );
  // printf("Esta es la transpuesta de datosIse 2x3: \n");
  // transMat(datosISE, 2, 3 );
  // printf("Esta es la multiplicacion A*B: \n");
  
  // imprimir_matriz(AB, n, m); 
  
  // printf("Esta es la transpuesta de A*B: \n");
  // float* transAB = transMat(AB, n, m);  
  // imprimir_matriz(transAB, m, n);   

  printf("Esta es la matriz C: \n");
  imprimir_matriz(C, n, m); 

  printf("Esta es la matriz BtZ: \n");
  imprimir_matriz(BtZ, m, 1);


    // liberamos memoria y evitamos fugas:
      delete [] Z;
      delete [] Y;
      delete [] X;
      delete [] A;
      delete [] B;
      // delete [] M;
      // delete [] T;
      // delete [] D;
      delete [] AB; 
      delete [] transB;
      delete [] BtAB; 
      delete [] adjBtAB;
      delete [] transAdjBtAB;
      delete [] invBtAB;
      delete [] C;  
      delete [] BtZ;
      // delete [] transDatosPrueba;
      // delete [] transAB; 
      // delete [] AdjD; 
      // delete [] transAdjD;
      // delete [] invMat;
      // delete [] unitMat; 
            
      Z = NULL; 
      Y = NULL;
      X = NULL;
      A = NULL;
      B = NULL;
      // M = NULL;
      // T = NULL;
      // D = NULL; 
      AB = NULL;
      transB = NULL;
      BtAB = NULL; 
      adjBtAB = NULL;
      transAdjBtAB = NULL;
      invBtAB = NULL;  
      C = NULL; 
      BtZ = NULL; 
      // transDatosPrueba = NULL;
      // transAB = NULL;
      // AdjD = NULL; 
      // transAdjD = NULL;
      // invMat = NULL;  
      // unitMat = NULL; 
}

// Funcion que imprime una mnatriz mxn cin m columnas y n filas
void imprimir_matriz(float X[], int m, int n ){
  for(int i=0;i<m;i++){
    for(int j=0;j<n;j++){
      printf("%5.2f  ", X[(i*n) + j]);
    }
    printf("\n");
  }
  
}

float* mulMat(float X[],float Y[], int xr, int xy, int yc ){
  float* MM =new float[xr*yc];
    for(int i=0; i<xr; i++){
    for(int j=0; j<yc; j++){
        float accumulator = 0;
        for(int k=0; k<xy; k++){
           accumulator += X[(i*xy) + k]*Y[(k*yc) + j]; 
        } 
        MM[(i*yc) + j] = accumulator;
      }
    }
    // imprimir_matriz(MM, xr, yc); 
    // transMat(MM, xr, yc);    
    // delete [] MM;
    // MM = NULL; 
    return MM; 
}


// Funcion para transponer una matriz cualquiera de tamano "xr X xc"
float* transMat(float X[], int m, int n ){
  // printf("\nEsta es su matriz:\n \n");
  // imprimir_matriz(X,m,n);
  
  float* TM =new float[m*n];
  for(int i=0; i<m; i++){
    for(int j=0; j<n; j++){
      //printf("(%d,%d) %d %d %d /  ",i,j,((n*i) + j), ((m*j)+i),1);
      TM[(m*j) + i] = X[(n*i) + j];
    }
    
  }
// imprimimos TM en pantalla:
// printf("Esta es su matriz traspuesta T: \n");
//   imprimir_matriz(TM,n,m);

  // delete [] TM;
  // TM = NULL;
  return TM;
}


float determinantTwo(float X[], int n){
  float determinant = 0; 

  // printf("Este es n: \n");
  // printf("%5d  ", n);
  if(n == 2){
  return (X[0]*X[3] - X[2]*X[1]);
  } else {
    // printf("La matriz D no es 2x2. \n");
      for(int j=0; j<n; j++){
        float* TD = new float[(n-1)*(n-1)];
        int x = 0; 
        for(int l=1; l<n; l++){
          int y = 0; 
            for(int m=0; m<n; m++){
            if((m == j))
            continue;
              TD[x*(n-1) + y ] = X[l*n + m ];
            y++;
            }
            x++;
        }
        // printf("Esta es la submatriz TD para j =");
        // printf("%5d  ", j);
        // printf(": \n");
        // imprimir_matriz(TD,n-1,n-1);
        determinant = determinant + (pow(-1, j)*X[j]*determinantTwo(TD,n-1));
        
        delete [] TD;
        TD = NULL; 
      }
  }
  
  return determinant; 
}

float* adjMat(float X[], int n){

  float* ADJ = new float[n*n];

  for (int i = 0; i < n; i++){
    for (int j = 0; j < n; j++){
      float* SUBM = new float[(n-1)*(n-1)];
      int x = 0; 
        for(int l=0; l<n; l++){
          int y = 0;
          if((l == i))
          continue;
            for(int m=0; m<n; m++){
            if((m == j))
            continue;
              SUBM[x*(n-1) + y ] = X[l*n + m ];
            y++;
            }
            x++;
        }

        

  printf("Esta es su matriz submatriz SUBM ");
  printf("con i =");
      printf("%2d", i);
  printf("y j =");
      printf("%2d", j);
  printf(" \n");
  imprimir_matriz(SUBM, n-1, n-1);
  printf(" \n");

  float determinante = determinantTwo(SUBM,n-1);
  printf("El determinante de SUBM es:");
  printf("%5.2f  ", determinante);
  printf("\n");


        ADJ[i*n + j] = pow(-1, 2 + i + j) * determinante;

        delete [] SUBM;
        SUBM = NULL; 
    }
  }

  // printf("Esta es su matriz adjunta ADJ: \n");
  // for(int i=0;i<n;i++){
  //   for(int j=0;j<n;j++){
  //     printf("%12.2f  ", ADJ[(i*n) + j]);
  //   }
  //   printf("\n");
  // }

  
  // printf("Esta es la transpuesta de ADJ: \n");
  // transMat(ADJ, n, n );
  

  // delete [] ADJ;

  // ADJ = NULL; 

  return ADJ;
}


float* divEscMat(float X[], float divisor, int n, int m){
  float* newMat = new float[n*m];

  for(int i=0; i<n; i++){
    for(int j=0; j<m; j++){
      newMat[(n*i) + j] = X[(n*i) + j] / divisor;
    }
  }

  return newMat;
}
